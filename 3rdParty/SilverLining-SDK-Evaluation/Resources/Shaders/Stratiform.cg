void main(  float4 position     : POSITION,
			float4 color        : COLOR,
			float3 texCoord     : TEXCOORD0,
			
       	out float4 oPosition    : POSITION,
		out float4 oColor       : COLOR,
        out float3 oTexCoord    : TEXCOORD0,
        out float  oFog         : FOG,
					
  uniform sampler2D psf : TEXUNIT0,
  uniform float4x4 modelViewProj,
  uniform float4x4 modelView,
  uniform float4 displacementVectorAndContrast
)
{
    oTexCoord = texCoord;
    
    float contrast = displacementVectorAndContrast.w;
    float3 displacement = ((tex2D(psf, texCoord.xy).x - (1.0 - contrast)) / contrast) * displacementVectorAndContrast.xyz;
    position.xyz += displacement;
    
    float3 eyePosition = mul(modelView, position).xyz;
	float fogDistance = length(eyePosition);
	
	oFog = fogDistance;
	
	oColor = color;
	
    oPosition = mul(modelViewProj, position);
}